<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>jumpscale.packages.auth.bottle.auth API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>jumpscale.packages.auth.bottle.auth</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">from functools import wraps
from json import JSONDecodeError
from urllib.parse import urlencode, quote, unquote

import nacl
import requests
from bottle import Bottle, request, abort, redirect, response
from nacl.public import Box
from nacl.signing import VerifyKey

from jumpscale.loader import j

REDIRECT_URL = &#34;https://login.threefold.me&#34;
CALLBACK_URL = &#34;/auth/3bot_callback&#34;
LOGIN_URL = &#34;/auth/login&#34;

app = Bottle()


@app.hook(&#34;before_request&#34;)
def setup_request():
    request.session = request.environ.get(&#34;beaker.session&#34;, {})


templates_path = j.sals.fs.join_paths(j.sals.fs.dirname(__file__), &#34;templates&#34;)
env = j.tools.jinja2.get_env(templates_path)


@app.route(&#34;/login&#34;)
def login():
    &#34;&#34;&#34;List available providers for login and redirect to the selected provider (ThreeFold Connect)

    Returns:
        Renders the template of login page
    &#34;&#34;&#34;
    session = request.environ.get(&#34;beaker.session&#34;, {})
    provider = request.query.get(&#34;provider&#34;)
    next_url = quote(request.query.get(&#34;next_url&#34;, session.get(&#34;next_url&#34;, &#34;/&#34;)))

    if provider and provider == &#34;3bot&#34;:
        state = j.data.idgenerator.chars(20)
        session[&#34;next_url&#34;] = next_url
        session[&#34;state&#34;] = state
        app_id = request.get_header(&#34;host&#34;)
        params = {
            &#34;state&#34;: state,
            &#34;appid&#34;: app_id,
            &#34;scope&#34;: j.data.serializers.json.dumps({&#34;user&#34;: True, &#34;email&#34;: True, &#34;walletAddress&#34;: True}),
            &#34;redirecturl&#34;: CALLBACK_URL,
            &#34;publickey&#34;: j.core.identity.me.nacl.public_key.encode(encoder=nacl.encoding.Base64Encoder),
        }
        params = urlencode(params)
        return redirect(f&#34;{REDIRECT_URL}?{params}&#34;, code=302)

    return env.get_template(&#34;login.html&#34;).render(providers=[], next_url=next_url)


@app.route(&#34;/3bot_callback&#34;)
def callback():
    &#34;&#34;&#34;Takes the response from the provider and verify the identity of the logged in user

    Returns:
        Redirect to the wanted page after authentication
    &#34;&#34;&#34;
    session = request.environ.get(&#34;beaker.session&#34;)
    data = request.query.get(&#34;signedAttempt&#34;)

    if not data:
        return abort(400, &#34;signedAttempt parameter is missing&#34;)

    data = j.data.serializers.json.loads(data)

    if &#34;signedAttempt&#34; not in data:
        return abort(400, &#34;signedAttempt value is missing&#34;)

    username = data[&#34;doubleName&#34;]

    if not username:
        return abort(400, &#34;DoubleName is missing&#34;)

    res = requests.get(f&#34;https://login.threefold.me/api/users/{username}&#34;, {&#34;Content-Type&#34;: &#34;application/json&#34;})
    if res.status_code != 200:
        return abort(400, &#34;Error getting user pub key&#34;)
    pub_key = res.json()[&#34;publicKey&#34;]

    user_pub_key = VerifyKey(j.data.serializers.base64.decode(pub_key))

    # verify data
    signedData = data[&#34;signedAttempt&#34;]

    verifiedData = user_pub_key.verify(j.data.serializers.base64.decode(signedData)).decode()

    data = j.data.serializers.json.loads(verifiedData)

    if &#34;doubleName&#34; not in data:
        return abort(400, &#34;Decrypted data does not contain (doubleName)&#34;)

    if &#34;signedState&#34; not in data:
        return abort(400, &#34;Decrypted data does not contain (state)&#34;)

    if data[&#34;doubleName&#34;] != username:
        return abort(400, &#34;username mismatch!&#34;)

    # verify state
    state = data[&#34;signedState&#34;]
    if state != session[&#34;state&#34;]:
        return abort(400, &#34;Invalid state. not matching one in user session&#34;)

    nonce = j.data.serializers.base64.decode(data[&#34;data&#34;][&#34;nonce&#34;])
    ciphertext = j.data.serializers.base64.decode(data[&#34;data&#34;][&#34;ciphertext&#34;])

    try:
        priv = j.core.identity.me.nacl.private_key
        box = Box(priv, user_pub_key.to_curve25519_public_key())
        decrypted = box.decrypt(ciphertext, nonce)
    except nacl.exceptions.CryptoError:
        return abort(400, &#34;Error decrypting data&#34;)

    try:
        result = j.data.serializers.json.loads(decrypted)
    except JSONDecodeError:
        return abort(400, &#34;3Bot login returned faulty data&#34;)

    if &#34;email&#34; not in result:
        return abort(400, &#34;Email is not present in data&#34;)

    email = result[&#34;email&#34;][&#34;email&#34;]

    sei = result[&#34;email&#34;][&#34;sei&#34;]
    res = requests.post(
        &#34;https://openkyc.live/verification/verify-sei&#34;,
        headers={&#34;Content-Type&#34;: &#34;application/json&#34;},
        json={&#34;signedEmailIdentifier&#34;: sei},
    )

    if res.status_code != 200:
        next_url = request.query.get(&#34;next_url&#34;, &#34;/auth/logout&#34;)
        return env.get_template(&#34;email_not_verified.html&#34;).render(next_url=next_url)

    username = username.lower()  # workaround usernames that are returned by signed attempt with camel cases
    session[&#34;username&#34;] = username
    session[&#34;email&#34;] = email
    session[&#34;authorized&#34;] = True
    session[&#34;signedAttempt&#34;] = signedData
    if result.get(&#34;walletAddressData&#34;):
        session[&#34;walletAddress&#34;] = result.get(&#34;walletAddressData&#34;).get(&#34;address&#34;)

    return redirect(unquote(session.get(&#34;next_url&#34;, &#34;/&#34;)))


@app.route(&#34;/logout&#34;)
def logout():
    &#34;&#34;&#34;Invalidates the user session and redirect to login page

    Returns:
        Redirect to the login page
    &#34;&#34;&#34;
    session = request.environ.get(&#34;beaker.session&#34;, {})
    try:
        session.invalidate()
    except AttributeError:
        pass

    next_url = request.query.get(&#34;next_url&#34;, &#34;/&#34;)
    return redirect(f&#34;{LOGIN_URL}?next_url={next_url}&#34;)


@app.route(&#34;/accessdenied&#34;)
def access_denied():
    &#34;&#34;&#34;Displays the access denied page when the authenticated user is not authorized to view the page

    Returns:
        Renders access denied page
    &#34;&#34;&#34;
    email = request.environ.get(&#34;beaker.session&#34;).get(&#34;email&#34;)
    next_url = request.query.get(&#34;next_url&#34;, &#34;/auth/logout&#34;)
    return env.get_template(&#34;access_denied.html&#34;).render(email=email, next_url=next_url)


@app.route(&#34;/auto_login&#34;)
def auto_login():
    &#34;&#34;&#34;Auto login is used for testing for skipping login and use the current user&#39;s info instead.

    Returns:
        Redirect to the admin dashboard.
    &#34;&#34;&#34;
    if j.core.config.get(&#34;AUTO_LOGIN&#34;):
        session = request.environ.get(&#34;beaker.session&#34;, {})
        session[&#34;username&#34;] = j.core.identity.me.tname
        session[&#34;email&#34;] = j.core.identity.me.email
        session[&#34;authorized&#34;] = True
        session[&#34;walletAddress&#34;] = &#34;&#34;

    return redirect(&#34;/admin&#34;)


def get_user_info():
    &#34;&#34;&#34;Parse user information from the session object

    Returns:
        [JSON string]: [user information session]
    &#34;&#34;&#34;

    def _valid(tname, temail):
        if not j.core.identity.is_configured:
            return False
        if tname != j.core.identity.me.tname:
            return False
        if temail != j.core.identity.me.email:
            return False
        return True

    session = request.environ.get(&#34;beaker.session&#34;, {})
    tname = session.get(&#34;username&#34;, &#34;&#34;)
    temail = session.get(&#34;email&#34;, &#34;&#34;)
    tid = session.get(&#34;tid&#34;, 0)
    wallet_address = session.get(&#34;walletAddress&#34;, &#34;&#34;)

    # update tid in session when the identity changes
    devmode = not j.core.identity.is_configured
    if not devmode and not _valid(tname, temail):
        session[&#34;tid&#34;] = None

    session.get(&#34;signedAttempt&#34;, &#34;&#34;)
    response.content_type = &#34;application/json&#34;
    return j.data.serializers.json.dumps(
        {
            &#34;username&#34;: tname.lower(),
            &#34;email&#34;: temail.lower(),
            &#34;tid&#34;: tid,
            &#34;devmode&#34;: not j.core.config.get_config().get(&#34;threebot_connect&#34;, True),
            &#34;walletAddress&#34;: wallet_address,
        }
    )


def is_admin(tname):
    &#34;&#34;&#34;Checks if the user provided is considered an admin or not

    Args:
        tname (str): threebot name

    Returns:
        [Bool]: [True if the user is an admin]
    &#34;&#34;&#34;
    if j.core.identity.is_configured:
        threebot_me = j.core.identity.me
        return threebot_me.tname == tname or tname in threebot_me.admins
    else:
        return True


def authenticated(handler):
    &#34;&#34;&#34;decorator for the methods to be for authenticated users only

    Args:
        handler (method)
    &#34;&#34;&#34;

    def decorator(*args, **kwargs):
        session = request.environ.get(&#34;beaker.session&#34;, {})
        if j.core.config.get_config().get(&#34;threebot_connect&#34;, True) and j.core.identity.is_configured:
            if not session.get(&#34;authorized&#34;, False):
                return abort(401)
        return handler(*args, **kwargs)

    return decorator


def admin_only(handler):
    &#34;&#34;&#34;decorator for methods for admin access only

    Args:
        handler (method)
    &#34;&#34;&#34;

    def decorator(*args, **kwargs):
        session = request.environ.get(&#34;beaker.session&#34;)
        if j.core.config.get_config().get(&#34;threebot_connect&#34;, True):
            username = session.get(&#34;username&#34;)
            if not is_admin(username):
                return abort(403)

        return handler(*args, **kwargs)

    return decorator


@app.route(&#34;/authenticated&#34;)
@authenticated
def is_authenticated():
    &#34;&#34;&#34;get user information if it is authenticated

    Returns:
        [JSON string]: [user information session]
    &#34;&#34;&#34;
    return get_user_info()


@app.route(&#34;/authorized&#34;)
@authenticated
@admin_only
def is_authorized():
    &#34;&#34;&#34;get user information if it is authenticated and authorized as admin only

    Returns:
        [JSON string]: [user information session]
    &#34;&#34;&#34;
    return get_user_info()


@app.route(&#34;/package_authorized/&lt;package_name&gt;&#34;)
@authenticated
def is_package_authorized(package_name):
    &#34;&#34;&#34;
    get user information if it is authorized user in the package config

    Returns:
        [JSON string]: [user information session]
    &#34;&#34;&#34;
    authorized_users = get_package_admins(package_name)
    user_info = get_user_info()
    user_dict = j.data.serializers.json.loads(user_info)
    username = user_dict[&#34;username&#34;]
    # if the package doesn&#39;t include admins then allow any authenticated user
    if authorized_users and not any([username in authorized_users, username in j.core.identity.me.admins]):
        return abort(403)
    return user_info


def package_authorized(package_name):
    def decorator(function):
        def wrapper(*args, **kwargs):
            authorized_users = get_package_admins(package_name)
            session = request.environ.get(&#34;beaker.session&#34;)
            username = session.get(&#34;username&#34;)
            if authorized_users and not any([username in authorized_users, username in j.core.identity.me.admins]):
                return abort(403)
            return function(*args, **kwargs)

        return wrapper

    return decorator


def login_required(func):
    &#34;&#34;&#34;Decorator for the methods we want to secure

    Args:
        func (method)
    &#34;&#34;&#34;

    @wraps(func)
    def decorator(*args, **kwargs):
        session = request.environ.get(&#34;beaker.session&#34;, {})
        if j.core.config.get_config().get(&#34;threebot_connect&#34;, True):
            if not session.get(&#34;authorized&#34;, False):
                session[&#34;next_url&#34;] = request.url
                return redirect(LOGIN_URL)
        return func(*args, **kwargs)

    return decorator


def add_package_user(package_name, username):
    package = j.servers.threebot.default.packages.get(package_name)
    if not package:
        raise j.exceptions.Validation(f&#34;can&#39;t add admin to non installed package {package_name}&#34;)
    package.admins.append(username)
    j.servers.threebot.default.packages.save()


def get_package_admins(package_name):
    package = j.servers.threebot.default.packages.get(package_name)
    if not package:
        raise j.exceptions.Validation(f&#34;package {package_name} is not installed&#34;)
    return package.admins</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="jumpscale.packages.auth.bottle.auth.access_denied"><code class="name flex">
<span>def <span class="ident">access_denied</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Displays the access denied page when the authenticated user is not authorized to view the page</p>
<h2 id="returns">Returns</h2>
<p>Renders access denied page</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@app.route(&#34;/accessdenied&#34;)
def access_denied():
    &#34;&#34;&#34;Displays the access denied page when the authenticated user is not authorized to view the page

    Returns:
        Renders access denied page
    &#34;&#34;&#34;
    email = request.environ.get(&#34;beaker.session&#34;).get(&#34;email&#34;)
    next_url = request.query.get(&#34;next_url&#34;, &#34;/auth/logout&#34;)
    return env.get_template(&#34;access_denied.html&#34;).render(email=email, next_url=next_url)</code></pre>
</details>
</dd>
<dt id="jumpscale.packages.auth.bottle.auth.add_package_user"><code class="name flex">
<span>def <span class="ident">add_package_user</span></span>(<span>package_name, username)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def add_package_user(package_name, username):
    package = j.servers.threebot.default.packages.get(package_name)
    if not package:
        raise j.exceptions.Validation(f&#34;can&#39;t add admin to non installed package {package_name}&#34;)
    package.admins.append(username)
    j.servers.threebot.default.packages.save()</code></pre>
</details>
</dd>
<dt id="jumpscale.packages.auth.bottle.auth.admin_only"><code class="name flex">
<span>def <span class="ident">admin_only</span></span>(<span>handler)</span>
</code></dt>
<dd>
<div class="desc"><p>decorator for methods for admin access only</p>
<h2 id="args">Args</h2>
<p>handler (method)</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def admin_only(handler):
    &#34;&#34;&#34;decorator for methods for admin access only

    Args:
        handler (method)
    &#34;&#34;&#34;

    def decorator(*args, **kwargs):
        session = request.environ.get(&#34;beaker.session&#34;)
        if j.core.config.get_config().get(&#34;threebot_connect&#34;, True):
            username = session.get(&#34;username&#34;)
            if not is_admin(username):
                return abort(403)

        return handler(*args, **kwargs)

    return decorator</code></pre>
</details>
</dd>
<dt id="jumpscale.packages.auth.bottle.auth.authenticated"><code class="name flex">
<span>def <span class="ident">authenticated</span></span>(<span>handler)</span>
</code></dt>
<dd>
<div class="desc"><p>decorator for the methods to be for authenticated users only</p>
<h2 id="args">Args</h2>
<p>handler (method)</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def authenticated(handler):
    &#34;&#34;&#34;decorator for the methods to be for authenticated users only

    Args:
        handler (method)
    &#34;&#34;&#34;

    def decorator(*args, **kwargs):
        session = request.environ.get(&#34;beaker.session&#34;, {})
        if j.core.config.get_config().get(&#34;threebot_connect&#34;, True) and j.core.identity.is_configured:
            if not session.get(&#34;authorized&#34;, False):
                return abort(401)
        return handler(*args, **kwargs)

    return decorator</code></pre>
</details>
</dd>
<dt id="jumpscale.packages.auth.bottle.auth.auto_login"><code class="name flex">
<span>def <span class="ident">auto_login</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Auto login is used for testing for skipping login and use the current user's info instead.</p>
<h2 id="returns">Returns</h2>
<p>Redirect to the admin dashboard.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@app.route(&#34;/auto_login&#34;)
def auto_login():
    &#34;&#34;&#34;Auto login is used for testing for skipping login and use the current user&#39;s info instead.

    Returns:
        Redirect to the admin dashboard.
    &#34;&#34;&#34;
    if j.core.config.get(&#34;AUTO_LOGIN&#34;):
        session = request.environ.get(&#34;beaker.session&#34;, {})
        session[&#34;username&#34;] = j.core.identity.me.tname
        session[&#34;email&#34;] = j.core.identity.me.email
        session[&#34;authorized&#34;] = True
        session[&#34;walletAddress&#34;] = &#34;&#34;

    return redirect(&#34;/admin&#34;)</code></pre>
</details>
</dd>
<dt id="jumpscale.packages.auth.bottle.auth.callback"><code class="name flex">
<span>def <span class="ident">callback</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Takes the response from the provider and verify the identity of the logged in user</p>
<h2 id="returns">Returns</h2>
<p>Redirect to the wanted page after authentication</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@app.route(&#34;/3bot_callback&#34;)
def callback():
    &#34;&#34;&#34;Takes the response from the provider and verify the identity of the logged in user

    Returns:
        Redirect to the wanted page after authentication
    &#34;&#34;&#34;
    session = request.environ.get(&#34;beaker.session&#34;)
    data = request.query.get(&#34;signedAttempt&#34;)

    if not data:
        return abort(400, &#34;signedAttempt parameter is missing&#34;)

    data = j.data.serializers.json.loads(data)

    if &#34;signedAttempt&#34; not in data:
        return abort(400, &#34;signedAttempt value is missing&#34;)

    username = data[&#34;doubleName&#34;]

    if not username:
        return abort(400, &#34;DoubleName is missing&#34;)

    res = requests.get(f&#34;https://login.threefold.me/api/users/{username}&#34;, {&#34;Content-Type&#34;: &#34;application/json&#34;})
    if res.status_code != 200:
        return abort(400, &#34;Error getting user pub key&#34;)
    pub_key = res.json()[&#34;publicKey&#34;]

    user_pub_key = VerifyKey(j.data.serializers.base64.decode(pub_key))

    # verify data
    signedData = data[&#34;signedAttempt&#34;]

    verifiedData = user_pub_key.verify(j.data.serializers.base64.decode(signedData)).decode()

    data = j.data.serializers.json.loads(verifiedData)

    if &#34;doubleName&#34; not in data:
        return abort(400, &#34;Decrypted data does not contain (doubleName)&#34;)

    if &#34;signedState&#34; not in data:
        return abort(400, &#34;Decrypted data does not contain (state)&#34;)

    if data[&#34;doubleName&#34;] != username:
        return abort(400, &#34;username mismatch!&#34;)

    # verify state
    state = data[&#34;signedState&#34;]
    if state != session[&#34;state&#34;]:
        return abort(400, &#34;Invalid state. not matching one in user session&#34;)

    nonce = j.data.serializers.base64.decode(data[&#34;data&#34;][&#34;nonce&#34;])
    ciphertext = j.data.serializers.base64.decode(data[&#34;data&#34;][&#34;ciphertext&#34;])

    try:
        priv = j.core.identity.me.nacl.private_key
        box = Box(priv, user_pub_key.to_curve25519_public_key())
        decrypted = box.decrypt(ciphertext, nonce)
    except nacl.exceptions.CryptoError:
        return abort(400, &#34;Error decrypting data&#34;)

    try:
        result = j.data.serializers.json.loads(decrypted)
    except JSONDecodeError:
        return abort(400, &#34;3Bot login returned faulty data&#34;)

    if &#34;email&#34; not in result:
        return abort(400, &#34;Email is not present in data&#34;)

    email = result[&#34;email&#34;][&#34;email&#34;]

    sei = result[&#34;email&#34;][&#34;sei&#34;]
    res = requests.post(
        &#34;https://openkyc.live/verification/verify-sei&#34;,
        headers={&#34;Content-Type&#34;: &#34;application/json&#34;},
        json={&#34;signedEmailIdentifier&#34;: sei},
    )

    if res.status_code != 200:
        next_url = request.query.get(&#34;next_url&#34;, &#34;/auth/logout&#34;)
        return env.get_template(&#34;email_not_verified.html&#34;).render(next_url=next_url)

    username = username.lower()  # workaround usernames that are returned by signed attempt with camel cases
    session[&#34;username&#34;] = username
    session[&#34;email&#34;] = email
    session[&#34;authorized&#34;] = True
    session[&#34;signedAttempt&#34;] = signedData
    if result.get(&#34;walletAddressData&#34;):
        session[&#34;walletAddress&#34;] = result.get(&#34;walletAddressData&#34;).get(&#34;address&#34;)

    return redirect(unquote(session.get(&#34;next_url&#34;, &#34;/&#34;)))</code></pre>
</details>
</dd>
<dt id="jumpscale.packages.auth.bottle.auth.get_package_admins"><code class="name flex">
<span>def <span class="ident">get_package_admins</span></span>(<span>package_name)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_package_admins(package_name):
    package = j.servers.threebot.default.packages.get(package_name)
    if not package:
        raise j.exceptions.Validation(f&#34;package {package_name} is not installed&#34;)
    return package.admins</code></pre>
</details>
</dd>
<dt id="jumpscale.packages.auth.bottle.auth.get_user_info"><code class="name flex">
<span>def <span class="ident">get_user_info</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Parse user information from the session object</p>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>[JSON string]</code></dt>
<dd>[user information session]</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def get_user_info():
    &#34;&#34;&#34;Parse user information from the session object

    Returns:
        [JSON string]: [user information session]
    &#34;&#34;&#34;

    def _valid(tname, temail):
        if not j.core.identity.is_configured:
            return False
        if tname != j.core.identity.me.tname:
            return False
        if temail != j.core.identity.me.email:
            return False
        return True

    session = request.environ.get(&#34;beaker.session&#34;, {})
    tname = session.get(&#34;username&#34;, &#34;&#34;)
    temail = session.get(&#34;email&#34;, &#34;&#34;)
    tid = session.get(&#34;tid&#34;, 0)
    wallet_address = session.get(&#34;walletAddress&#34;, &#34;&#34;)

    # update tid in session when the identity changes
    devmode = not j.core.identity.is_configured
    if not devmode and not _valid(tname, temail):
        session[&#34;tid&#34;] = None

    session.get(&#34;signedAttempt&#34;, &#34;&#34;)
    response.content_type = &#34;application/json&#34;
    return j.data.serializers.json.dumps(
        {
            &#34;username&#34;: tname.lower(),
            &#34;email&#34;: temail.lower(),
            &#34;tid&#34;: tid,
            &#34;devmode&#34;: not j.core.config.get_config().get(&#34;threebot_connect&#34;, True),
            &#34;walletAddress&#34;: wallet_address,
        }
    )</code></pre>
</details>
</dd>
<dt id="jumpscale.packages.auth.bottle.auth.is_admin"><code class="name flex">
<span>def <span class="ident">is_admin</span></span>(<span>tname)</span>
</code></dt>
<dd>
<div class="desc"><p>Checks if the user provided is considered an admin or not</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>tname</code></strong> :&ensp;<code>str</code></dt>
<dd>threebot name</dd>
</dl>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>[Bool]</code></dt>
<dd>[True if the user is an admin]</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def is_admin(tname):
    &#34;&#34;&#34;Checks if the user provided is considered an admin or not

    Args:
        tname (str): threebot name

    Returns:
        [Bool]: [True if the user is an admin]
    &#34;&#34;&#34;
    if j.core.identity.is_configured:
        threebot_me = j.core.identity.me
        return threebot_me.tname == tname or tname in threebot_me.admins
    else:
        return True</code></pre>
</details>
</dd>
<dt id="jumpscale.packages.auth.bottle.auth.is_authenticated"><code class="name flex">
<span>def <span class="ident">is_authenticated</span></span>(<span>*args, **kwargs)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def decorator(*args, **kwargs):
    session = request.environ.get(&#34;beaker.session&#34;, {})
    if j.core.config.get_config().get(&#34;threebot_connect&#34;, True) and j.core.identity.is_configured:
        if not session.get(&#34;authorized&#34;, False):
            return abort(401)
    return handler(*args, **kwargs)</code></pre>
</details>
</dd>
<dt id="jumpscale.packages.auth.bottle.auth.is_authorized"><code class="name flex">
<span>def <span class="ident">is_authorized</span></span>(<span>*args, **kwargs)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def decorator(*args, **kwargs):
    session = request.environ.get(&#34;beaker.session&#34;, {})
    if j.core.config.get_config().get(&#34;threebot_connect&#34;, True) and j.core.identity.is_configured:
        if not session.get(&#34;authorized&#34;, False):
            return abort(401)
    return handler(*args, **kwargs)</code></pre>
</details>
</dd>
<dt id="jumpscale.packages.auth.bottle.auth.is_package_authorized"><code class="name flex">
<span>def <span class="ident">is_package_authorized</span></span>(<span>*args, **kwargs)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def decorator(*args, **kwargs):
    session = request.environ.get(&#34;beaker.session&#34;, {})
    if j.core.config.get_config().get(&#34;threebot_connect&#34;, True) and j.core.identity.is_configured:
        if not session.get(&#34;authorized&#34;, False):
            return abort(401)
    return handler(*args, **kwargs)</code></pre>
</details>
</dd>
<dt id="jumpscale.packages.auth.bottle.auth.login"><code class="name flex">
<span>def <span class="ident">login</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>List available providers for login and redirect to the selected provider (ThreeFold Connect)</p>
<h2 id="returns">Returns</h2>
<p>Renders the template of login page</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@app.route(&#34;/login&#34;)
def login():
    &#34;&#34;&#34;List available providers for login and redirect to the selected provider (ThreeFold Connect)

    Returns:
        Renders the template of login page
    &#34;&#34;&#34;
    session = request.environ.get(&#34;beaker.session&#34;, {})
    provider = request.query.get(&#34;provider&#34;)
    next_url = quote(request.query.get(&#34;next_url&#34;, session.get(&#34;next_url&#34;, &#34;/&#34;)))

    if provider and provider == &#34;3bot&#34;:
        state = j.data.idgenerator.chars(20)
        session[&#34;next_url&#34;] = next_url
        session[&#34;state&#34;] = state
        app_id = request.get_header(&#34;host&#34;)
        params = {
            &#34;state&#34;: state,
            &#34;appid&#34;: app_id,
            &#34;scope&#34;: j.data.serializers.json.dumps({&#34;user&#34;: True, &#34;email&#34;: True, &#34;walletAddress&#34;: True}),
            &#34;redirecturl&#34;: CALLBACK_URL,
            &#34;publickey&#34;: j.core.identity.me.nacl.public_key.encode(encoder=nacl.encoding.Base64Encoder),
        }
        params = urlencode(params)
        return redirect(f&#34;{REDIRECT_URL}?{params}&#34;, code=302)

    return env.get_template(&#34;login.html&#34;).render(providers=[], next_url=next_url)</code></pre>
</details>
</dd>
<dt id="jumpscale.packages.auth.bottle.auth.login_required"><code class="name flex">
<span>def <span class="ident">login_required</span></span>(<span>func)</span>
</code></dt>
<dd>
<div class="desc"><p>Decorator for the methods we want to secure</p>
<h2 id="args">Args</h2>
<p>func (method)</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def login_required(func):
    &#34;&#34;&#34;Decorator for the methods we want to secure

    Args:
        func (method)
    &#34;&#34;&#34;

    @wraps(func)
    def decorator(*args, **kwargs):
        session = request.environ.get(&#34;beaker.session&#34;, {})
        if j.core.config.get_config().get(&#34;threebot_connect&#34;, True):
            if not session.get(&#34;authorized&#34;, False):
                session[&#34;next_url&#34;] = request.url
                return redirect(LOGIN_URL)
        return func(*args, **kwargs)

    return decorator</code></pre>
</details>
</dd>
<dt id="jumpscale.packages.auth.bottle.auth.logout"><code class="name flex">
<span>def <span class="ident">logout</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Invalidates the user session and redirect to login page</p>
<h2 id="returns">Returns</h2>
<p>Redirect to the login page</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@app.route(&#34;/logout&#34;)
def logout():
    &#34;&#34;&#34;Invalidates the user session and redirect to login page

    Returns:
        Redirect to the login page
    &#34;&#34;&#34;
    session = request.environ.get(&#34;beaker.session&#34;, {})
    try:
        session.invalidate()
    except AttributeError:
        pass

    next_url = request.query.get(&#34;next_url&#34;, &#34;/&#34;)
    return redirect(f&#34;{LOGIN_URL}?next_url={next_url}&#34;)</code></pre>
</details>
</dd>
<dt id="jumpscale.packages.auth.bottle.auth.package_authorized"><code class="name flex">
<span>def <span class="ident">package_authorized</span></span>(<span>package_name)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def package_authorized(package_name):
    def decorator(function):
        def wrapper(*args, **kwargs):
            authorized_users = get_package_admins(package_name)
            session = request.environ.get(&#34;beaker.session&#34;)
            username = session.get(&#34;username&#34;)
            if authorized_users and not any([username in authorized_users, username in j.core.identity.me.admins]):
                return abort(403)
            return function(*args, **kwargs)

        return wrapper

    return decorator</code></pre>
</details>
</dd>
<dt id="jumpscale.packages.auth.bottle.auth.setup_request"><code class="name flex">
<span>def <span class="ident">setup_request</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@app.hook(&#34;before_request&#34;)
def setup_request():
    request.session = request.environ.get(&#34;beaker.session&#34;, {})</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="jumpscale.packages.auth.bottle" href="index.html">jumpscale.packages.auth.bottle</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="jumpscale.packages.auth.bottle.auth.access_denied" href="#jumpscale.packages.auth.bottle.auth.access_denied">access_denied</a></code></li>
<li><code><a title="jumpscale.packages.auth.bottle.auth.add_package_user" href="#jumpscale.packages.auth.bottle.auth.add_package_user">add_package_user</a></code></li>
<li><code><a title="jumpscale.packages.auth.bottle.auth.admin_only" href="#jumpscale.packages.auth.bottle.auth.admin_only">admin_only</a></code></li>
<li><code><a title="jumpscale.packages.auth.bottle.auth.authenticated" href="#jumpscale.packages.auth.bottle.auth.authenticated">authenticated</a></code></li>
<li><code><a title="jumpscale.packages.auth.bottle.auth.auto_login" href="#jumpscale.packages.auth.bottle.auth.auto_login">auto_login</a></code></li>
<li><code><a title="jumpscale.packages.auth.bottle.auth.callback" href="#jumpscale.packages.auth.bottle.auth.callback">callback</a></code></li>
<li><code><a title="jumpscale.packages.auth.bottle.auth.get_package_admins" href="#jumpscale.packages.auth.bottle.auth.get_package_admins">get_package_admins</a></code></li>
<li><code><a title="jumpscale.packages.auth.bottle.auth.get_user_info" href="#jumpscale.packages.auth.bottle.auth.get_user_info">get_user_info</a></code></li>
<li><code><a title="jumpscale.packages.auth.bottle.auth.is_admin" href="#jumpscale.packages.auth.bottle.auth.is_admin">is_admin</a></code></li>
<li><code><a title="jumpscale.packages.auth.bottle.auth.is_authenticated" href="#jumpscale.packages.auth.bottle.auth.is_authenticated">is_authenticated</a></code></li>
<li><code><a title="jumpscale.packages.auth.bottle.auth.is_authorized" href="#jumpscale.packages.auth.bottle.auth.is_authorized">is_authorized</a></code></li>
<li><code><a title="jumpscale.packages.auth.bottle.auth.is_package_authorized" href="#jumpscale.packages.auth.bottle.auth.is_package_authorized">is_package_authorized</a></code></li>
<li><code><a title="jumpscale.packages.auth.bottle.auth.login" href="#jumpscale.packages.auth.bottle.auth.login">login</a></code></li>
<li><code><a title="jumpscale.packages.auth.bottle.auth.login_required" href="#jumpscale.packages.auth.bottle.auth.login_required">login_required</a></code></li>
<li><code><a title="jumpscale.packages.auth.bottle.auth.logout" href="#jumpscale.packages.auth.bottle.auth.logout">logout</a></code></li>
<li><code><a title="jumpscale.packages.auth.bottle.auth.package_authorized" href="#jumpscale.packages.auth.bottle.auth.package_authorized">package_authorized</a></code></li>
<li><code><a title="jumpscale.packages.auth.bottle.auth.setup_request" href="#jumpscale.packages.auth.bottle.auth.setup_request">setup_request</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>