<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.6.4" />
<title>jumpscale.servers.gedis.server API documentation</title>
<meta name="description" content="" />
<link href='https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css' rel='stylesheet'>
<link href='https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/8.0.0/sanitize.min.css' rel='stylesheet'>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" rel="stylesheet">
<style>.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{font-weight:bold}#index h4 + ul{margin-bottom:.6em}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase;cursor:pointer}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>jumpscale.servers.gedis.server</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>Source code</summary>
<pre><code class="python">import inspect
import json
import sys
import os
from redis import Redis
from enum import Enum
from functools import partial
from io import BytesIO
from signal import SIGKILL, SIGTERM
import json
import gevent
from gevent.pool import Pool
from gevent import time
from gevent.server import StreamServer
from jumpscale.core.base import Base, fields
from jumpscale.loader import j
from redis.connection import DefaultParser, Encoder
from redis.exceptions import ConnectionError
from .baseactor import BaseActor
from .systemactor import CoreActor, SystemActor


def serialize(obj):
    if not isinstance(obj, (str, int, float, list, tuple, dict, bool)):
        module = inspect.getmodule(obj).__file__[:-3]
        return dict(__serialized__=True, module=module, type=obj.__class__.__name__, data=obj.to_dict())
    return obj


def deserialize(obj):
    if isinstance(obj, dict) and obj.get(&#34;__serialized__&#34;):
        module = sys.modules[obj[&#34;module&#34;]]
        object_instance = getattr(module, obj[&#34;type&#34;])()
        object_instance.from_dict(obj[&#34;data&#34;])
        return object_instance
    return obj


class GedisErrorTypes(Enum):
    NOT_FOUND = 0
    BAD_REQUEST = 1
    ACTOR_ERROR = 3
    INTERNAL_SERVER_ERROR = 4
    PERMISSION_ERROR = 5


EXCEPTIONS_MAP = {
    j.exceptions.Value: GedisErrorTypes.BAD_REQUEST.value,
    j.exceptions.NotFound: GedisErrorTypes.NOT_FOUND.value,
    j.exceptions.Permission: GedisErrorTypes.PERMISSION_ERROR.value,
}


class RedisConnectionAdapter:
    def __init__(self, sock):
        self.socket = sock
        self._sock = sock
        self.socket_timeout = 600
        self.socket_connect_timeout = 600
        self.socket_keepalive = True
        self.retry_on_timeout = True
        self.socket_keepalive_options = {}
        self.encoder = Encoder(&#34;utf&#34;, &#34;strict&#34;, False)


class ResponseEncoder:
    def __init__(self, socket):
        self.socket = socket
        self.buffer = BytesIO()

    def encode(self, value):
        &#34;&#34;&#34;Respond with data.&#34;&#34;&#34;
        if value is None:
            self._write_buffer(&#34;$-1\r\n&#34;)
        elif isinstance(value, int):
            self._write_buffer(&#34;:{}\r\n&#34;.format(value))
        elif isinstance(value, bool):
            self._write_buffer(&#34;:{}\r\n&#34;.format(1 if value else 0))
        elif isinstance(value, str):
            if &#34;\n&#34; in value:
                self._bulk(value)
            else:
                self._write_buffer(&#34;+{}\r\n&#34;.format(value))
        elif isinstance(value, bytes):
            self._bulkbytes(value)
        elif isinstance(value, list):
            if value and value[0] == &#34;*REDIS*&#34;:
                value = value[1:]
            self._array(value)
        elif hasattr(value, &#34;__repr__&#34;):
            self._bulk(value.__repr__())
        else:
            value = j.data.serializers.json.dumps(value, encoding=&#34;utf-8&#34;)
            self.encode(value)

        self._send()

    def status(self, msg=&#34;OK&#34;):
        &#34;&#34;&#34;Send a status.&#34;&#34;&#34;
        self._write_buffer(&#34;+{}\r\n&#34;.format(msg))
        self._send()

    def error(self, msg):
        &#34;&#34;&#34;Send an error.&#34;&#34;&#34;
        # print(&#34;###:%s&#34; % msg)
        self._write_buffer(&#34;-ERR {}\r\n&#34;.format(msg))
        self._send()

    def _bulk(self, value):
        &#34;&#34;&#34;Send part of a multiline reply.&#34;&#34;&#34;
        data = [&#34;$&#34;, str(len(value)), &#34;\r\n&#34;, value, &#34;\r\n&#34;]
        self._write_buffer(&#34;&#34;.join(data))

    def _array(self, value):
        &#34;&#34;&#34;send an array.&#34;&#34;&#34;
        self._write_buffer(&#34;*{}\r\n&#34;.format(len(value)))
        for item in value:
            self.encode(item)

    def _bulkbytes(self, value):
        data = [b&#34;$&#34;, str(len(value)).encode(), b&#34;\r\n&#34;, value, b&#34;\r\n&#34;]
        self._write_buffer(b&#34;&#34;.join(data))

    def _write_buffer(self, data):
        if isinstance(data, str):
            data = data.encode()

        self.buffer.write(data)

    def _send(self):
        self.socket.sendall(self.buffer.getvalue())
        self.buffer = BytesIO()  # seems faster then truncating


SERIALIZABLE_TYPES = (str, int, float, list, tuple, dict, bool)
RESERVED_ACTOR_NAMES = (&#34;core&#34;, &#34;system&#34;)


class GedisServer(Base):
    host = fields.String(default=&#34;127.0.0.1&#34;)
    port = fields.Integer(default=16000)
    enable_system_actor = fields.Boolean(default=True)
    run_async = fields.Boolean(default=True)
    _actors = fields.Typed(dict, default={})

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self._core_actor = CoreActor()
        self._system_actor = SystemActor()
        self._loaded_actors = {&#34;core&#34;: self._core_actor}

    @property
    def actors(self):
        &#34;&#34;&#34;Lists saved actors

        Returns:
            list -- List of saved actors
        &#34;&#34;&#34;
        return self._actors

    def actor_add(self, actor_name: str, actor_path: str):
        &#34;&#34;&#34;Adds an actor to the server

        Arguments:
            actor_name {str} -- Actor name
            actor_path {str} -- Actor absolute path

        Raises:
            j.exceptions.Value: raises if actor name is matched one of the reserved actor names
            j.exceptions.Value: raises if actor name is not a valid identifier
        &#34;&#34;&#34;
        if actor_name in RESERVED_ACTOR_NAMES:
            raise j.exceptions.Value(&#34;Invalid actor name&#34;)

        if not actor_name.isidentifier():
            raise j.exceptions.Value(f&#34;Actor name should be a valid identifier&#34;)

        self._actors[actor_name] = actor_path

    def actor_delete(self, actor_name: str):
        &#34;&#34;&#34;Removes an actor from the server

        Arguments:
            actor_name {str} -- Actor name
        &#34;&#34;&#34;
        self._actors.pop(actor_name, None)

    def start(self):
        &#34;&#34;&#34;Starts the server
        &#34;&#34;&#34;
        j.application.start(&#34;gedis&#34;)

        # handle signals
        for signal_type in (SIGTERM, SIGKILL):
            gevent.signal(signal_type, self.stop)

        # register system actor if enabled
        if self.enable_system_actor:
            self._register_actor(&#34;system&#34;, self._system_actor)

        self._core_actor.set_server(self)
        self._system_actor.set_server(self)

        # register saved actors
        for actor_name, actor_path in self._actors.items():
            self._system_actor.register_actor(actor_name, actor_path)

        # start the server
        self._server = StreamServer((self.host, self.port), self._on_connection, spawn=Pool())
        self._server.reuse_addr = True
        self._server.start()

    def stop(self):
        &#34;&#34;&#34;Stops the server
        &#34;&#34;&#34;
        j.logger.info(&#34;Shutting down...&#34;)
        self._server.stop()

    def _register_actor(self, actor_name: str, actor_module: BaseActor):
        self._loaded_actors[actor_name] = actor_module

    def _unregister_actor(self, actor_name: str):
        self._loaded_actors.pop(actor_name, None)

    def _execute(self, method, args, kwargs):
        response = {}
        try:
            response[&#34;result&#34;] = method(*args, **kwargs)

        except Exception as e:
            response[&#34;error&#34;] = str(e)
            response[&#34;error_type&#34;] = EXCEPTIONS_MAP.get(e.__class__, GedisErrorTypes.ACTOR_ERROR.value)

        return response

    def _on_connection(self, socket, address):
        j.logger.info(&#34;New connection from {}&#34;, address)
        parser = DefaultParser(65536)
        connection = RedisConnectionAdapter(socket)
        try:
            encoder = ResponseEncoder(socket)
            parser.on_connect(connection)

            while True:
                response = dict(success=True, result=None, error=None, error_type=None, is_async=False, task_id=None)
                try:
                    request = parser.read_response()

                    if len(request) &lt; 2:
                        response[&#34;error&#34;] = &#34;invalid request&#34;
                        response[&#34;error_type&#34;] = GedisErrorTypes.BAD_REQUEST.value

                    else:
                        actor_name = request.pop(0).decode()
                        method_name = request.pop(0).decode()
                        actor_object = self._loaded_actors.get(actor_name)

                        if not actor_object:
                            response[&#34;error&#34;] = &#34;actor not found&#34;
                            response[&#34;error_type&#34;] = GedisErrorTypes.NOT_FOUND.value

                        elif not hasattr(actor_object, method_name):
                            response[&#34;error&#34;] = &#34;method not found&#34;
                            response[&#34;error_type&#34;] = GedisErrorTypes.NOT_FOUND.value

                        else:
                            j.logger.info(
                                &#34;Executing method {} from actor {} to client {}&#34;, method_name, actor_name, address
                            )

                            if request:
                                args, kwargs = json.loads(request.pop(0), object_hook=deserialize)
                            else:
                                args, kwargs = (), {}

                            method = getattr(actor_object, method_name)
                            result = self._execute(method, args, kwargs)
                            response.update(result)

                except ConnectionError:
                    j.logger.info(&#34;Client {} closed the connection&#34;, address)

                except Exception as exception:
                    j.logger.exception(&#34;internal error&#34;, exception=exception)
                    response[&#34;error&#34;] = &#34;internal server error&#34;
                    response[&#34;error_type&#34;] = GedisErrorTypes.INTERNAL_SERVER_ERROR.value

                response[&#34;success&#34;] = response[&#34;error&#34;] is None
                encoder.encode(json.dumps(response, default=serialize))

            parser.on_disconnect()

        except BrokenPipeError:
            pass</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="jumpscale.servers.gedis.server.deserialize"><code class="name flex">
<span>def <span class="ident">deserialize</span></span>(<span>obj)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>Source code</summary>
<pre><code class="python">def deserialize(obj):
    if isinstance(obj, dict) and obj.get(&#34;__serialized__&#34;):
        module = sys.modules[obj[&#34;module&#34;]]
        object_instance = getattr(module, obj[&#34;type&#34;])()
        object_instance.from_dict(obj[&#34;data&#34;])
        return object_instance
    return obj</code></pre>
</details>
</dd>
<dt id="jumpscale.servers.gedis.server.serialize"><code class="name flex">
<span>def <span class="ident">serialize</span></span>(<span>obj)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>Source code</summary>
<pre><code class="python">def serialize(obj):
    if not isinstance(obj, (str, int, float, list, tuple, dict, bool)):
        module = inspect.getmodule(obj).__file__[:-3]
        return dict(__serialized__=True, module=module, type=obj.__class__.__name__, data=obj.to_dict())
    return obj</code></pre>
</details>
</dd>
</dl>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="jumpscale.servers.gedis.server.GedisErrorTypes"><code class="flex name class">
<span>class <span class="ident">GedisErrorTypes</span></span>
<span>(</span><span>*args, **kwargs)</span>
</code></dt>
<dd>
<section class="desc"><p>An enumeration.</p></section>
<details class="source">
<summary>Source code</summary>
<pre><code class="python">class GedisErrorTypes(Enum):
    NOT_FOUND = 0
    BAD_REQUEST = 1
    ACTOR_ERROR = 3
    INTERNAL_SERVER_ERROR = 4
    PERMISSION_ERROR = 5</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li>enum.Enum</li>
</ul>
<h3>Class variables</h3>
<dl>
<dt id="jumpscale.servers.gedis.server.GedisErrorTypes.ACTOR_ERROR"><code class="name">var <span class="ident">ACTOR_ERROR</span></code></dt>
<dd>
<section class="desc"></section>
</dd>
<dt id="jumpscale.servers.gedis.server.GedisErrorTypes.BAD_REQUEST"><code class="name">var <span class="ident">BAD_REQUEST</span></code></dt>
<dd>
<section class="desc"></section>
</dd>
<dt id="jumpscale.servers.gedis.server.GedisErrorTypes.INTERNAL_SERVER_ERROR"><code class="name">var <span class="ident">INTERNAL_SERVER_ERROR</span></code></dt>
<dd>
<section class="desc"></section>
</dd>
<dt id="jumpscale.servers.gedis.server.GedisErrorTypes.NOT_FOUND"><code class="name">var <span class="ident">NOT_FOUND</span></code></dt>
<dd>
<section class="desc"></section>
</dd>
<dt id="jumpscale.servers.gedis.server.GedisErrorTypes.PERMISSION_ERROR"><code class="name">var <span class="ident">PERMISSION_ERROR</span></code></dt>
<dd>
<section class="desc"></section>
</dd>
</dl>
</dd>
<dt id="jumpscale.servers.gedis.server.GedisServer"><code class="flex name class">
<span>class <span class="ident">GedisServer</span></span>
<span>(</span><span>*args, **kwargs)</span>
</code></dt>
<dd>
<section class="desc"><p>A simple attribute-based namespace.</p>
<p>SimpleNamespace(**kwargs)</p>
<p>base class implementation for any class with fields which supports getting/setting raw data for any instance fields.</p>
<p>any instance can have an optional name and a parent.</p>
<pre><code class="python">class Person(Base):
    name = fields.String()
    age = fields.Float()

p = Person(name=&quot;ahmed&quot;, age=&quot;19&quot;)
print(p.name, p.age)
</code></pre>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>parent_</code></strong> :&ensp;<code>Base</code>, optional</dt>
<dd>parent instance. Defaults to None.</dd>
<dt><strong><code>instance_name_</code></strong> :&ensp;<code>str</code>, optional</dt>
<dd>instance name. Defaults to None.</dd>
<dt><strong><code>**values</code></strong></dt>
<dd>any given field values to initiate the instance with</dd>
</dl></section>
<details class="source">
<summary>Source code</summary>
<pre><code class="python">class GedisServer(Base):
    host = fields.String(default=&#34;127.0.0.1&#34;)
    port = fields.Integer(default=16000)
    enable_system_actor = fields.Boolean(default=True)
    run_async = fields.Boolean(default=True)
    _actors = fields.Typed(dict, default={})

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self._core_actor = CoreActor()
        self._system_actor = SystemActor()
        self._loaded_actors = {&#34;core&#34;: self._core_actor}

    @property
    def actors(self):
        &#34;&#34;&#34;Lists saved actors

        Returns:
            list -- List of saved actors
        &#34;&#34;&#34;
        return self._actors

    def actor_add(self, actor_name: str, actor_path: str):
        &#34;&#34;&#34;Adds an actor to the server

        Arguments:
            actor_name {str} -- Actor name
            actor_path {str} -- Actor absolute path

        Raises:
            j.exceptions.Value: raises if actor name is matched one of the reserved actor names
            j.exceptions.Value: raises if actor name is not a valid identifier
        &#34;&#34;&#34;
        if actor_name in RESERVED_ACTOR_NAMES:
            raise j.exceptions.Value(&#34;Invalid actor name&#34;)

        if not actor_name.isidentifier():
            raise j.exceptions.Value(f&#34;Actor name should be a valid identifier&#34;)

        self._actors[actor_name] = actor_path

    def actor_delete(self, actor_name: str):
        &#34;&#34;&#34;Removes an actor from the server

        Arguments:
            actor_name {str} -- Actor name
        &#34;&#34;&#34;
        self._actors.pop(actor_name, None)

    def start(self):
        &#34;&#34;&#34;Starts the server
        &#34;&#34;&#34;
        j.application.start(&#34;gedis&#34;)

        # handle signals
        for signal_type in (SIGTERM, SIGKILL):
            gevent.signal(signal_type, self.stop)

        # register system actor if enabled
        if self.enable_system_actor:
            self._register_actor(&#34;system&#34;, self._system_actor)

        self._core_actor.set_server(self)
        self._system_actor.set_server(self)

        # register saved actors
        for actor_name, actor_path in self._actors.items():
            self._system_actor.register_actor(actor_name, actor_path)

        # start the server
        self._server = StreamServer((self.host, self.port), self._on_connection, spawn=Pool())
        self._server.reuse_addr = True
        self._server.start()

    def stop(self):
        &#34;&#34;&#34;Stops the server
        &#34;&#34;&#34;
        j.logger.info(&#34;Shutting down...&#34;)
        self._server.stop()

    def _register_actor(self, actor_name: str, actor_module: BaseActor):
        self._loaded_actors[actor_name] = actor_module

    def _unregister_actor(self, actor_name: str):
        self._loaded_actors.pop(actor_name, None)

    def _execute(self, method, args, kwargs):
        response = {}
        try:
            response[&#34;result&#34;] = method(*args, **kwargs)

        except Exception as e:
            response[&#34;error&#34;] = str(e)
            response[&#34;error_type&#34;] = EXCEPTIONS_MAP.get(e.__class__, GedisErrorTypes.ACTOR_ERROR.value)

        return response

    def _on_connection(self, socket, address):
        j.logger.info(&#34;New connection from {}&#34;, address)
        parser = DefaultParser(65536)
        connection = RedisConnectionAdapter(socket)
        try:
            encoder = ResponseEncoder(socket)
            parser.on_connect(connection)

            while True:
                response = dict(success=True, result=None, error=None, error_type=None, is_async=False, task_id=None)
                try:
                    request = parser.read_response()

                    if len(request) &lt; 2:
                        response[&#34;error&#34;] = &#34;invalid request&#34;
                        response[&#34;error_type&#34;] = GedisErrorTypes.BAD_REQUEST.value

                    else:
                        actor_name = request.pop(0).decode()
                        method_name = request.pop(0).decode()
                        actor_object = self._loaded_actors.get(actor_name)

                        if not actor_object:
                            response[&#34;error&#34;] = &#34;actor not found&#34;
                            response[&#34;error_type&#34;] = GedisErrorTypes.NOT_FOUND.value

                        elif not hasattr(actor_object, method_name):
                            response[&#34;error&#34;] = &#34;method not found&#34;
                            response[&#34;error_type&#34;] = GedisErrorTypes.NOT_FOUND.value

                        else:
                            j.logger.info(
                                &#34;Executing method {} from actor {} to client {}&#34;, method_name, actor_name, address
                            )

                            if request:
                                args, kwargs = json.loads(request.pop(0), object_hook=deserialize)
                            else:
                                args, kwargs = (), {}

                            method = getattr(actor_object, method_name)
                            result = self._execute(method, args, kwargs)
                            response.update(result)

                except ConnectionError:
                    j.logger.info(&#34;Client {} closed the connection&#34;, address)

                except Exception as exception:
                    j.logger.exception(&#34;internal error&#34;, exception=exception)
                    response[&#34;error&#34;] = &#34;internal server error&#34;
                    response[&#34;error_type&#34;] = GedisErrorTypes.INTERNAL_SERVER_ERROR.value

                response[&#34;success&#34;] = response[&#34;error&#34;] is None
                encoder.encode(json.dumps(response, default=serialize))

            parser.on_disconnect()

        except BrokenPipeError:
            pass</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="jumpscale.core.base.meta.Base" href="../../core/base/meta.html#jumpscale.core.base.meta.Base">Base</a></li>
<li>types.SimpleNamespace</li>
</ul>
<h3>Instance variables</h3>
<dl>
<dt id="jumpscale.servers.gedis.server.GedisServer.actors"><code class="name">var <span class="ident">actors</span></code></dt>
<dd>
<section class="desc"><p>Lists saved actors</p>
<h2 id="returns">Returns</h2>
<dl>
<dt><code>list</code> &ndash; <code>List</code> of <code>saved</code> <code>actors</code></dt>
<dd>&nbsp;</dd>
</dl></section>
<details class="source">
<summary>Source code</summary>
<pre><code class="python">@property
def actors(self):
    &#34;&#34;&#34;Lists saved actors

    Returns:
        list -- List of saved actors
    &#34;&#34;&#34;
    return self._actors</code></pre>
</details>
</dd>
<dt id="jumpscale.servers.gedis.server.GedisServer.enable_system_actor"><code class="name">var <span class="ident">enable_system_actor</span></code></dt>
<dd>
<section class="desc"><p>getter method this property</p>
<p>will call <code>_get_value</code>, which would if the value is already defined
and will get the default value if not</p>
<h2 id="returns">Returns</h2>
<dl>
<dt><strong><code>any</code></strong></dt>
<dd>the field value</dd>
</dl></section>
<details class="source">
<summary>Source code</summary>
<pre><code class="python">def getter(self):
    &#34;&#34;&#34;
    getter method this property

    will call `_get_value`, which would if the value is already defined
    and will get the default value if not

    Returns:
        any: the field value
    &#34;&#34;&#34;
    return self._get_value(name, field)</code></pre>
</details>
</dd>
<dt id="jumpscale.servers.gedis.server.GedisServer.host"><code class="name">var <span class="ident">host</span></code></dt>
<dd>
<section class="desc"><p>getter method this property</p>
<p>will call <code>_get_value</code>, which would if the value is already defined
and will get the default value if not</p>
<h2 id="returns">Returns</h2>
<dl>
<dt><strong><code>any</code></strong></dt>
<dd>the field value</dd>
</dl></section>
<details class="source">
<summary>Source code</summary>
<pre><code class="python">def getter(self):
    &#34;&#34;&#34;
    getter method this property

    will call `_get_value`, which would if the value is already defined
    and will get the default value if not

    Returns:
        any: the field value
    &#34;&#34;&#34;
    return self._get_value(name, field)</code></pre>
</details>
</dd>
<dt id="jumpscale.servers.gedis.server.GedisServer.port"><code class="name">var <span class="ident">port</span></code></dt>
<dd>
<section class="desc"><p>getter method this property</p>
<p>will call <code>_get_value</code>, which would if the value is already defined
and will get the default value if not</p>
<h2 id="returns">Returns</h2>
<dl>
<dt><strong><code>any</code></strong></dt>
<dd>the field value</dd>
</dl></section>
<details class="source">
<summary>Source code</summary>
<pre><code class="python">def getter(self):
    &#34;&#34;&#34;
    getter method this property

    will call `_get_value`, which would if the value is already defined
    and will get the default value if not

    Returns:
        any: the field value
    &#34;&#34;&#34;
    return self._get_value(name, field)</code></pre>
</details>
</dd>
<dt id="jumpscale.servers.gedis.server.GedisServer.run_async"><code class="name">var <span class="ident">run_async</span></code></dt>
<dd>
<section class="desc"><p>getter method this property</p>
<p>will call <code>_get_value</code>, which would if the value is already defined
and will get the default value if not</p>
<h2 id="returns">Returns</h2>
<dl>
<dt><strong><code>any</code></strong></dt>
<dd>the field value</dd>
</dl></section>
<details class="source">
<summary>Source code</summary>
<pre><code class="python">def getter(self):
    &#34;&#34;&#34;
    getter method this property

    will call `_get_value`, which would if the value is already defined
    and will get the default value if not

    Returns:
        any: the field value
    &#34;&#34;&#34;
    return self._get_value(name, field)</code></pre>
</details>
</dd>
</dl>
<h3>Methods</h3>
<dl>
<dt id="jumpscale.servers.gedis.server.GedisServer.actor_add"><code class="name flex">
<span>def <span class="ident">actor_add</span></span>(<span>self, actor_name, actor_path)</span>
</code></dt>
<dd>
<section class="desc"><p>Adds an actor to the server</p>
<h2 id="arguments">Arguments</h2>
<p>actor_name {str} &ndash; Actor name
actor_path {str} &ndash; Actor absolute path</p>
<h2 id="raises">Raises</h2>
<dl>
<dt><code>j.exceptions.Value</code>: <code>raises</code> <code>if</code> <code>actor</code> <code>name</code> <code>is</code> <code>matched</code> <code>one</code> of <code>the</code> <code>reserved</code> <code>actor</code> <code>names</code></dt>
<dd>&nbsp;</dd>
<dt><code>j.exceptions.Value</code>: <code>raises</code> <code>if</code> <code>actor</code> <code>name</code> <code>is</code> <code>not</code> <code>a</code> <code>valid</code> <code>identifier</code></dt>
<dd>&nbsp;</dd>
</dl></section>
<details class="source">
<summary>Source code</summary>
<pre><code class="python">def actor_add(self, actor_name: str, actor_path: str):
    &#34;&#34;&#34;Adds an actor to the server

    Arguments:
        actor_name {str} -- Actor name
        actor_path {str} -- Actor absolute path

    Raises:
        j.exceptions.Value: raises if actor name is matched one of the reserved actor names
        j.exceptions.Value: raises if actor name is not a valid identifier
    &#34;&#34;&#34;
    if actor_name in RESERVED_ACTOR_NAMES:
        raise j.exceptions.Value(&#34;Invalid actor name&#34;)

    if not actor_name.isidentifier():
        raise j.exceptions.Value(f&#34;Actor name should be a valid identifier&#34;)

    self._actors[actor_name] = actor_path</code></pre>
</details>
</dd>
<dt id="jumpscale.servers.gedis.server.GedisServer.actor_delete"><code class="name flex">
<span>def <span class="ident">actor_delete</span></span>(<span>self, actor_name)</span>
</code></dt>
<dd>
<section class="desc"><p>Removes an actor from the server</p>
<h2 id="arguments">Arguments</h2>
<p>actor_name {str} &ndash; Actor name</p></section>
<details class="source">
<summary>Source code</summary>
<pre><code class="python">def actor_delete(self, actor_name: str):
    &#34;&#34;&#34;Removes an actor from the server

    Arguments:
        actor_name {str} -- Actor name
    &#34;&#34;&#34;
    self._actors.pop(actor_name, None)</code></pre>
</details>
</dd>
<dt id="jumpscale.servers.gedis.server.GedisServer.start"><code class="name flex">
<span>def <span class="ident">start</span></span>(<span>self)</span>
</code></dt>
<dd>
<section class="desc"><p>Starts the server</p></section>
<details class="source">
<summary>Source code</summary>
<pre><code class="python">def start(self):
    &#34;&#34;&#34;Starts the server
    &#34;&#34;&#34;
    j.application.start(&#34;gedis&#34;)

    # handle signals
    for signal_type in (SIGTERM, SIGKILL):
        gevent.signal(signal_type, self.stop)

    # register system actor if enabled
    if self.enable_system_actor:
        self._register_actor(&#34;system&#34;, self._system_actor)

    self._core_actor.set_server(self)
    self._system_actor.set_server(self)

    # register saved actors
    for actor_name, actor_path in self._actors.items():
        self._system_actor.register_actor(actor_name, actor_path)

    # start the server
    self._server = StreamServer((self.host, self.port), self._on_connection, spawn=Pool())
    self._server.reuse_addr = True
    self._server.start()</code></pre>
</details>
</dd>
<dt id="jumpscale.servers.gedis.server.GedisServer.stop"><code class="name flex">
<span>def <span class="ident">stop</span></span>(<span>self)</span>
</code></dt>
<dd>
<section class="desc"><p>Stops the server</p></section>
<details class="source">
<summary>Source code</summary>
<pre><code class="python">def stop(self):
    &#34;&#34;&#34;Stops the server
    &#34;&#34;&#34;
    j.logger.info(&#34;Shutting down...&#34;)
    self._server.stop()</code></pre>
</details>
</dd>
</dl>
<h3>Inherited members</h3>
<ul class="hlist">
<li><code><b><a title="jumpscale.core.base.meta.Base" href="../../core/base/meta.html#jumpscale.core.base.meta.Base">Base</a></b></code>:
<ul class="hlist">
<li><code><a title="jumpscale.core.base.meta.Base.from_dict" href="../../core/base/meta.html#jumpscale.core.base.meta.Base.from_dict">from_dict</a></code></li>
<li><code><a title="jumpscale.core.base.meta.Base.to_dict" href="../../core/base/meta.html#jumpscale.core.base.meta.Base.to_dict">to_dict</a></code></li>
<li><code><a title="jumpscale.core.base.meta.Base.validate" href="../../core/base/meta.html#jumpscale.core.base.meta.Base.validate">validate</a></code></li>
</ul>
</li>
</ul>
</dd>
<dt id="jumpscale.servers.gedis.server.RedisConnectionAdapter"><code class="flex name class">
<span>class <span class="ident">RedisConnectionAdapter</span></span>
<span>(</span><span>sock)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>Source code</summary>
<pre><code class="python">class RedisConnectionAdapter:
    def __init__(self, sock):
        self.socket = sock
        self._sock = sock
        self.socket_timeout = 600
        self.socket_connect_timeout = 600
        self.socket_keepalive = True
        self.retry_on_timeout = True
        self.socket_keepalive_options = {}
        self.encoder = Encoder(&#34;utf&#34;, &#34;strict&#34;, False)</code></pre>
</details>
</dd>
<dt id="jumpscale.servers.gedis.server.ResponseEncoder"><code class="flex name class">
<span>class <span class="ident">ResponseEncoder</span></span>
<span>(</span><span>socket)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>Source code</summary>
<pre><code class="python">class ResponseEncoder:
    def __init__(self, socket):
        self.socket = socket
        self.buffer = BytesIO()

    def encode(self, value):
        &#34;&#34;&#34;Respond with data.&#34;&#34;&#34;
        if value is None:
            self._write_buffer(&#34;$-1\r\n&#34;)
        elif isinstance(value, int):
            self._write_buffer(&#34;:{}\r\n&#34;.format(value))
        elif isinstance(value, bool):
            self._write_buffer(&#34;:{}\r\n&#34;.format(1 if value else 0))
        elif isinstance(value, str):
            if &#34;\n&#34; in value:
                self._bulk(value)
            else:
                self._write_buffer(&#34;+{}\r\n&#34;.format(value))
        elif isinstance(value, bytes):
            self._bulkbytes(value)
        elif isinstance(value, list):
            if value and value[0] == &#34;*REDIS*&#34;:
                value = value[1:]
            self._array(value)
        elif hasattr(value, &#34;__repr__&#34;):
            self._bulk(value.__repr__())
        else:
            value = j.data.serializers.json.dumps(value, encoding=&#34;utf-8&#34;)
            self.encode(value)

        self._send()

    def status(self, msg=&#34;OK&#34;):
        &#34;&#34;&#34;Send a status.&#34;&#34;&#34;
        self._write_buffer(&#34;+{}\r\n&#34;.format(msg))
        self._send()

    def error(self, msg):
        &#34;&#34;&#34;Send an error.&#34;&#34;&#34;
        # print(&#34;###:%s&#34; % msg)
        self._write_buffer(&#34;-ERR {}\r\n&#34;.format(msg))
        self._send()

    def _bulk(self, value):
        &#34;&#34;&#34;Send part of a multiline reply.&#34;&#34;&#34;
        data = [&#34;$&#34;, str(len(value)), &#34;\r\n&#34;, value, &#34;\r\n&#34;]
        self._write_buffer(&#34;&#34;.join(data))

    def _array(self, value):
        &#34;&#34;&#34;send an array.&#34;&#34;&#34;
        self._write_buffer(&#34;*{}\r\n&#34;.format(len(value)))
        for item in value:
            self.encode(item)

    def _bulkbytes(self, value):
        data = [b&#34;$&#34;, str(len(value)).encode(), b&#34;\r\n&#34;, value, b&#34;\r\n&#34;]
        self._write_buffer(b&#34;&#34;.join(data))

    def _write_buffer(self, data):
        if isinstance(data, str):
            data = data.encode()

        self.buffer.write(data)

    def _send(self):
        self.socket.sendall(self.buffer.getvalue())
        self.buffer = BytesIO()  # seems faster then truncating</code></pre>
</details>
<h3>Methods</h3>
<dl>
<dt id="jumpscale.servers.gedis.server.ResponseEncoder.encode"><code class="name flex">
<span>def <span class="ident">encode</span></span>(<span>self, value)</span>
</code></dt>
<dd>
<section class="desc"><p>Respond with data.</p></section>
<details class="source">
<summary>Source code</summary>
<pre><code class="python">def encode(self, value):
    &#34;&#34;&#34;Respond with data.&#34;&#34;&#34;
    if value is None:
        self._write_buffer(&#34;$-1\r\n&#34;)
    elif isinstance(value, int):
        self._write_buffer(&#34;:{}\r\n&#34;.format(value))
    elif isinstance(value, bool):
        self._write_buffer(&#34;:{}\r\n&#34;.format(1 if value else 0))
    elif isinstance(value, str):
        if &#34;\n&#34; in value:
            self._bulk(value)
        else:
            self._write_buffer(&#34;+{}\r\n&#34;.format(value))
    elif isinstance(value, bytes):
        self._bulkbytes(value)
    elif isinstance(value, list):
        if value and value[0] == &#34;*REDIS*&#34;:
            value = value[1:]
        self._array(value)
    elif hasattr(value, &#34;__repr__&#34;):
        self._bulk(value.__repr__())
    else:
        value = j.data.serializers.json.dumps(value, encoding=&#34;utf-8&#34;)
        self.encode(value)

    self._send()</code></pre>
</details>
</dd>
<dt id="jumpscale.servers.gedis.server.ResponseEncoder.error"><code class="name flex">
<span>def <span class="ident">error</span></span>(<span>self, msg)</span>
</code></dt>
<dd>
<section class="desc"><p>Send an error.</p></section>
<details class="source">
<summary>Source code</summary>
<pre><code class="python">def error(self, msg):
    &#34;&#34;&#34;Send an error.&#34;&#34;&#34;
    # print(&#34;###:%s&#34; % msg)
    self._write_buffer(&#34;-ERR {}\r\n&#34;.format(msg))
    self._send()</code></pre>
</details>
</dd>
<dt id="jumpscale.servers.gedis.server.ResponseEncoder.status"><code class="name flex">
<span>def <span class="ident">status</span></span>(<span>self, msg=&#39;OK&#39;)</span>
</code></dt>
<dd>
<section class="desc"><p>Send a status.</p></section>
<details class="source">
<summary>Source code</summary>
<pre><code class="python">def status(self, msg=&#34;OK&#34;):
    &#34;&#34;&#34;Send a status.&#34;&#34;&#34;
    self._write_buffer(&#34;+{}\r\n&#34;.format(msg))
    self._send()</code></pre>
</details>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="jumpscale.servers.gedis" href="index.html">jumpscale.servers.gedis</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="jumpscale.servers.gedis.server.deserialize" href="#jumpscale.servers.gedis.server.deserialize">deserialize</a></code></li>
<li><code><a title="jumpscale.servers.gedis.server.serialize" href="#jumpscale.servers.gedis.server.serialize">serialize</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="jumpscale.servers.gedis.server.GedisErrorTypes" href="#jumpscale.servers.gedis.server.GedisErrorTypes">GedisErrorTypes</a></code></h4>
<ul class="">
<li><code><a title="jumpscale.servers.gedis.server.GedisErrorTypes.ACTOR_ERROR" href="#jumpscale.servers.gedis.server.GedisErrorTypes.ACTOR_ERROR">ACTOR_ERROR</a></code></li>
<li><code><a title="jumpscale.servers.gedis.server.GedisErrorTypes.BAD_REQUEST" href="#jumpscale.servers.gedis.server.GedisErrorTypes.BAD_REQUEST">BAD_REQUEST</a></code></li>
<li><code><a title="jumpscale.servers.gedis.server.GedisErrorTypes.INTERNAL_SERVER_ERROR" href="#jumpscale.servers.gedis.server.GedisErrorTypes.INTERNAL_SERVER_ERROR">INTERNAL_SERVER_ERROR</a></code></li>
<li><code><a title="jumpscale.servers.gedis.server.GedisErrorTypes.NOT_FOUND" href="#jumpscale.servers.gedis.server.GedisErrorTypes.NOT_FOUND">NOT_FOUND</a></code></li>
<li><code><a title="jumpscale.servers.gedis.server.GedisErrorTypes.PERMISSION_ERROR" href="#jumpscale.servers.gedis.server.GedisErrorTypes.PERMISSION_ERROR">PERMISSION_ERROR</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="jumpscale.servers.gedis.server.GedisServer" href="#jumpscale.servers.gedis.server.GedisServer">GedisServer</a></code></h4>
<ul class="two-column">
<li><code><a title="jumpscale.servers.gedis.server.GedisServer.actor_add" href="#jumpscale.servers.gedis.server.GedisServer.actor_add">actor_add</a></code></li>
<li><code><a title="jumpscale.servers.gedis.server.GedisServer.actor_delete" href="#jumpscale.servers.gedis.server.GedisServer.actor_delete">actor_delete</a></code></li>
<li><code><a title="jumpscale.servers.gedis.server.GedisServer.actors" href="#jumpscale.servers.gedis.server.GedisServer.actors">actors</a></code></li>
<li><code><a title="jumpscale.servers.gedis.server.GedisServer.enable_system_actor" href="#jumpscale.servers.gedis.server.GedisServer.enable_system_actor">enable_system_actor</a></code></li>
<li><code><a title="jumpscale.servers.gedis.server.GedisServer.host" href="#jumpscale.servers.gedis.server.GedisServer.host">host</a></code></li>
<li><code><a title="jumpscale.servers.gedis.server.GedisServer.port" href="#jumpscale.servers.gedis.server.GedisServer.port">port</a></code></li>
<li><code><a title="jumpscale.servers.gedis.server.GedisServer.run_async" href="#jumpscale.servers.gedis.server.GedisServer.run_async">run_async</a></code></li>
<li><code><a title="jumpscale.servers.gedis.server.GedisServer.start" href="#jumpscale.servers.gedis.server.GedisServer.start">start</a></code></li>
<li><code><a title="jumpscale.servers.gedis.server.GedisServer.stop" href="#jumpscale.servers.gedis.server.GedisServer.stop">stop</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="jumpscale.servers.gedis.server.RedisConnectionAdapter" href="#jumpscale.servers.gedis.server.RedisConnectionAdapter">RedisConnectionAdapter</a></code></h4>
</li>
<li>
<h4><code><a title="jumpscale.servers.gedis.server.ResponseEncoder" href="#jumpscale.servers.gedis.server.ResponseEncoder">ResponseEncoder</a></code></h4>
<ul class="">
<li><code><a title="jumpscale.servers.gedis.server.ResponseEncoder.encode" href="#jumpscale.servers.gedis.server.ResponseEncoder.encode">encode</a></code></li>
<li><code><a title="jumpscale.servers.gedis.server.ResponseEncoder.error" href="#jumpscale.servers.gedis.server.ResponseEncoder.error">error</a></code></li>
<li><code><a title="jumpscale.servers.gedis.server.ResponseEncoder.status" href="#jumpscale.servers.gedis.server.ResponseEncoder.status">status</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.6.4</a>.</p>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad()</script>
</body>
</html>